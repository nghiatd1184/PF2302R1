<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    
    <div>
        <canvas id="board" width="400" height="400" style="background-image: url(bg.jpg);"></canvas>
        <form>
            <h2 id="highestScore">Điểm cao nhất: 0</h2>
            <h2 id="score">Điểm hiện tại: 0</h2>
        </form>
    </div>
    <button type="button" onclick="startGame()">Bắt đầu / Chơi lại</button> 

    <script>
        class Snake {
            constructor(x, y) {
                this.x = x;
                this.y = y;
            }
        }
        
        let canvas = document.getElementById("board");
        let head = canvas.getContext("2d");
        let apple = canvas.getContext("2d");
        let body = canvas.getContext("2d");
        let highestScore = document.getElementById("highestScore");
        let move, max, headup, headdown, headleft, headright, tailup, taildown, tailleft, tailright, appleimg, bodyright, bodyleft, leftup, rightup, leftdown, rightdown;
        let appleLocationX = Math.floor(Math.random()*18 + 1) * 20; 
        let appleLocationY = Math.floor(Math.random()*18 + 1) * 20;
        let direction = 'up';
        let appleEated = false;
        let score = [];
        let snake = [];
        snake.push(new  Snake(180, 180));
        snake.push(new  Snake(180, 200));
        snake.push(new  Snake(180, 220));

        loadImage();

        function loadImage() {
            headup = new Image();
            headup.src = 'headup.png';
        }

        function drawSnake() {
            head.clearRect(0, 0, 400, 400);
            for (let i = 0; i < snake.length; i++) {
                if (i === 0) {
                    head.beginPath();
                    if (direction === 'up') {
                        head.drawImage(headup, snake[i].x, snake[i].y);
                    }
                } else {
                    body.beginPath();
                    body.fillStyle = "green";
                    body.fillRect(snake[i].x, snake[i].y, 20, 20)
                }
            }
        }

        function controlSnake() {
            for (let i = snake.length - 1; i > 0; i--) {
                snake[i].x = snake[(i-1)].x;
                snake[i].y = snake[(i-1)].y;
            }
            if (direction === 'up') {
                snake[0].y -= 20;
            }
            if (direction === 'down') {
                snake[0].y += 20;
            }
            if (direction === 'left') {
                snake[0].x -= 20;
            }
            if (direction === 'right') {
                snake[0].x += 20;
            }
        }

        function randomApple() {
            if (appleEated) {
                appleLocationX = Math.floor(Math.random()*18 + 1) * 20; 
                appleLocationY = Math.floor(Math.random()*18 + 1) * 20;
                appleEated = false;
            }
            apple.beginPath();
            apple.fillStyle = 'red';
            apple.fillRect(appleLocationX, appleLocationY, 20, 20);
        }

        function eatApple() {
            if (snake[0].x === appleLocationX && snake[0].y === appleLocationY) {
                if (direction === 'up') {
                    snake.unshift(new  Snake(snake[0].x, snake[0].y - 20));
                }
                if (direction === 'down') {
                    snake.unshift(new  Snake(snake[0].x, snake[0].y + 20));
                }
                if (direction === 'left') {
                    snake.unshift(new  Snake(snake[0].x -20, snake[0].y));
                }
                if (direction === 'right') {
                    snake.unshift(new  Snake(snake[0].x + 20, snake[0].y));
                }
                appleEated = true;
                document.getElementById("score").innerHTML =`Điểm hiện tại: ${snake.length - 3}`;
            }
        }

        function gameOver() {
            if (snake[0].x >= 400 || snake[0].x < 0 || snake[0].y < 0 || snake[0].y >= 400) {
                return true;
            }
            for (let i = 1; i < snake.length; i++) {
                if (snake[0].x === snake[i].x && snake[0].y === snake[i].y ) {
                return true;
                }
            }
            return false;
        }

        onkeydown = function(e) {
                    let key = e.keyCode;
                    if (key === 38 && direction !== 'down') {
                       direction = 'up';
                    }
                    if (key === 40 && direction !== 'up') {
                       direction = 'down';
                    }
                    if (key === 37 && direction !== 'right') {
                       direction = 'left';
                    }
                    if (key === 39 && direction !== 'left') {
                       direction = 'right';
                    }
        //up = 38, down = 40, left = 37, right = 39
        }

        function gamePlay() {
            if (gameOver()) {
                head.clearRect(0, 0, 400, 400);
                head.beginPath();
                head.font = '40px Arial';
                head.fillStyle = 'red';
                head.fillText('GAMEOVER', 80, 210);
                score.push(snake.length - 3);
                max = score[0];
                for (let i = 1; i < score.length; i++) {
                    if (score[i] > max) {
                        max = score[i];
                    }
                }
                highestScore.innerHTML = `Điểm cao nhất: ${max}`;
                clearInterval(move);
            } else {
                setTimeout(drawSnake(),50);
                randomApple();
                setTimeout(controlSnake(),50);
                eatApple();
            }
        }

        function startGame() {
            move = null;
            appleLocationX = Math.floor(Math.random()*18 + 1) * 20; 
            appleLocationY = Math.floor(Math.random()*18 + 1) * 20;
            direction = 'up';
            appleEated = false;
            snake = [];
            snake.push(new  Snake(180, 180));
            snake.push(new  Snake(180, 200));
            snake.push(new  Snake(180, 220));
            move = setInterval(gamePlay,150);
        }
    </script>
</body>
</html>